from abc import ABC, abstractmethod
import os
import pickle
from BundleGenerator import Bundle


class Benchmarker:
    """
    Validates the matches of user specified matching algorithms.

    Using data about the query and train images (stored as a bundle), it is
    possible to map a keypoint from the query image to a keypoint on the train
    image (and vice versa). First, we let the matching algorithm produce a list
    of matches which contain keypoints in the query and train images. Using data
    about the query and train images from the bundle, we map every keypoint
    (generated by the matching algorithm) from the query image to the train image.
    Finally, by noting how far the train keypoints produced by the matching algorithm
    are from our correctly mapped keypoints, we can score each algorithm based on how
    many of its keypoints fell within a certain distance threshold from the correctly
    mapped keypoints. A better score means that more of the keypoints generated by the
    algorithm in the train image were close to the keypoints in the trian image that
    we generated based off of the bundle data.

    Instance Attributes:
        Bundles (list): A list of Bundle objects.
        Algorithms (list): A list of MatchingAlgorithm objects to be benchmarked.
    """

    def __init__(self, algorithms):
        self.bundles = self.get_bundles()
        self.algorithms = algorithms

    def get_bundles(self):
        """
        Loads the bundle objects from a pickle file.

        Returns: A list of Bundle objects.
        """
        bundles_path = (
            f"{os.path.dirname(os.path.dirname(__file__))}\\images\\bundles.pkl"
        )
        with open(bundles_path, "rb") as bundles_file:
            bundles = pickle.load(bundles_file)
        return bundles

    def benchmark(self):
        """
        Scores each algorithm based on how close their matches are with matches
        produced by the bundle data for each image pair.
        """
        for algorithm in self.algorithms:
            for bundle in self.bundles:
                pass
